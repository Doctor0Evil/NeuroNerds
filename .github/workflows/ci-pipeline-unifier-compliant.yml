# Workflow: CI_PIPELINE_UNIFIER (HEAVILY SANITIZED, ALN-compliant)
# Legal-Definition: Unified pipeline enforcing compliance, safe bot logic, artifact handling, robust audit. No unsafe shell, jokes, or ambiguous syntax.

name: CI_PIPELINE_UNIFIER

on:
  push:
    branches: [main, develop, earliest-critical]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  issues: read
  actions: read

concurrency:
  group: CI_UNIFY_${{ github.workflow }}_${{ github.ref }}
  cancel-in-progress: false

env:
  DIR_AUDIT: .bithub/audit
  LOG_HUMOR: .bithub/logs/humor-bot.log
  DIR_POL: .bithub/policies
  FILE_OPA_RES: .bithub/audit/opa-result.json
  FILE_TRACE: .bithub/audit/humor-bot-trace.json
  RUN_ID: ${{ github.run_id }}

jobs:
  COMPLIANCECHK:
    name: POLICY_GATE
    runs-on: [self-hosted, bitbot-secure-group]
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@v2.7.0
        with:
          egress-policy: 'audit'
      - name: Validate PR actor and content
        uses: actions/github-script@v7
        env:
          PR_BODY: ${{ github.event.pull_request.body || '' }}
        with:
          script: |
            const allowed = ['trusted-dev1','trusted-dev2','github-actions[bot]'];
            if (!allowed.includes(context.actor)) {
              core.setFailed(`Unauthorized PR actor: ${context.actor}`);
              return;
            }
            const body = process.env.PR_BODY || "";
            const block = [/ignore.*above/i, /break.*compliance/i, /system prompt/i];
            if (block.some(p => p.test(body))) {
              core.setFailed("Prompt injection blocked.");
              return;
            }
            console.log("Compliance gate passed");

  FILECORRUPT:
    name: CORRECT_STUFF
    needs: COMPLIANCECHK
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - name: Checkout (full-depth)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup PowerShell (non-Windows)
        if: runner.os != 'Windows'
        uses: actions/setup-pwsh@v3
        with:
          pwsh-version: latest
      - name: Run corrections (guarded)
        shell: pwsh
        run: |
          $script = "$env:GITHUB_WORKSPACE/scripts/run-all-corrections.ps1"
          if (!(Test-Path $script)) { throw "No script found ($script)"; }
          & $script
      - name: Commit and push (robust audit)
        shell: bash
        run: |
          git config user.name "BOT-CORRECTOR"
          git config user.email "actions@github.com"
          git add .
          if git diff --cached --quiet; then echo "No changes to commit."; exit 0; fi
          git commit -m "autofix: correction run $(date)"
          for n in 1 2 3; do
            echo "Attempt $n to push..."
            if git pull --rebase origin "${GITHUB_REF_NAME}" && git push origin "${GITHUB_REF_NAME}"; then
              echo "Push successful!"
              exit 0
            fi
            echo "Push failed. Waiting before retry..."
            sleep 10
          done
          echo "::error::Failed to push changes."
          exit 1
      - name: Upload compliance audit log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit_${{ matrix.os }}
          path: scripts/audit-session.log
          retention-days: 12

  HUMORBOTCHECK:
    name: AI_HUMOR
    needs: COMPLIANCECHK
    runs-on: [self-hosted, bitbot-secure-group, windows]
    steps:
      - name: Checkout safely
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
      - name: Setup PowerShell
        uses: actions/setup-pwsh@v3
        with:
          pwsh-version: '7.4'
      - name: Audit humor log (neutral/ALN)
        shell: pwsh
        run: |
          $msg = "Audit-only: AI in 1992 was just a spreadsheet macro."
          Write-Host "*** Logging audit message ***"
          New-Item -ItemType Directory -Force -Path (Split-Path "${{ env.LOG_HUMOR }}") | Out-Null
          Add-Content -Path "${{ env.LOG_HUMOR }}" -Value "$(Get-Date -Format o) :: $msg"
      - name: Write humor bot trace (safe)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${{ env.DIR_AUDIT }}" | Out-Null
          $trace = @{
            schema    = "bithub.trace.v1"
            component = "humor.bot"
            run_id    = "${{ env.RUN_ID }}"
            status    = "done"
            timestamp = (Get-Date).ToUniversalTime().ToString("o")
          } | ConvertTo-Json -Depth 5
          $trace | Out-File -FilePath "${{ env.FILE_TRACE }}" -Encoding utf8
      - name: Simulate OPA result (legal)
        shell: pwsh
        run: |
          Write-Host "OPA simulated."
          '{"result":"pass"}' | Out-File -FilePath "${{ env.FILE_OPA_RES }}" -Encoding utf8

  FAILESCALATE:
    name: ON_FAIL_RUNNER
    needs: [FILECORRUPT, HUMORBOTCHECK]
    if: failure()
    runs-on: [self-hosted, bitbot-secure-group]
    steps:
      - name: Fail escalation notification
        shell: pwsh
        run: |
          Write-Host "Pipeline execution failedâ€”escalation recorded."
