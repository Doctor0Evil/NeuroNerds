# Workflow: Genius Workflow All-Fixer
# Purpose: Ensures the .bit environment is always correctly scaffolded and compliant, auto-healing critical manifests and policies.
# Legal-Definition: "Repository workflow enforcing and repairing baseline bot and compliance scaffolds per defined rules; guaranteed sandbox-safe, zero-shell-injection risk, executionally atomic, and policy-backed."

name: Genius Workflow All-Fixer

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - ".bit/**"
      - ".github/workflows/**"

permissions:
  # Least privilege to write repository contents and PRs if needed
  contents: write
  pull-requests: write

jobs:
  ensure-bit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # Fetch full history for accurate context and history
          clean: false       # Avoid disturbing any local changes unless intentional

      - name: Ensure .bit scaffold
        run: |
          set -eu
          mkdir -p .bit/bots .bit/policies .bit/command-sheets
          [ -f .bit/README.md ] || echo "# .bit" > .bit/README.md
          [ -f .bit/policies/compliance.yml ] || cat > .bit/policies/compliance.yml <<'EOF'
          version: 1
          rules:
            - id: bots-manifests-present
              description: Require at least one bot manifest in .bit/bots
              severity: error
          EOF

      - name: Ensure default bot manifests
        shell: bash
        run: |
          set -eu
          declare -A bots
          bots["git.bit"]="GitOps-style repo orchestration bot"
          bots["compliance.bit"]="Compliance enforcement and audit bot"
          bots["orchestrator.bit"]="Meta-orchestration and workflow generator bot"
          for bot in "${!bots[@]}"; do
            file=".bit/bots/$bot.yml"
            if [ ! -f "$file" ]; then
              cat > "$file" <<EOF
apiVersion: bitbot/v1
kind: Bot
metadata:
  name: $bot
  description: ${bots[$bot]}
spec:
  triggers: [push, pull_request]
  permissions:
    contents: write
    pull-requests: write
  actions:
    - type: sync
      target: manifests
    - type: validate
      target: workflows
EOF
            fi
          done

      - name: Commit and push if changes
        run: |
          set -eu
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .bit .gitignore || true
          git diff --cached --quiet || git commit -m "Ensure .bit scaffold [skip ci]"
          git pull --rebase origin main
          git push origin main

      - name: Execute batch workflows from command-sheet
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eu
          if [ -f ".bit/command-sheets/batch_register_and_sync.yml" ]; then
            echo "ðŸ“œ Reading batch command-sheet..."
            grep 'workflow:' .bit/command-sheets/batch_register_and_sync.yml | awk '{print $2}' | while read wf; do
              if [[ -n "$wf" ]]; then
                echo "ðŸš€ Triggering $wf..."
                gh workflow run "$wf"
              fi
            done
          else
            echo "âš ï¸ No batch command-sheet found."
