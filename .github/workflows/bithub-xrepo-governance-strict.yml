# Workflow: Bit.Hub Cross-Repo Governance Orchestrator (Ultra-Strict, Failsafe)
# Legal-Definition: Absolute cross-repo governance and syncing/validation with robust failsafe procedures and ethical boundary enforcement.

name: Bit.Hub Cross-Repo Governance Orchestrator

on:
  workflow_run:
    workflows:
      - Bit.Hub Pipeline Supremacy CI
      - Bit.Hub Policy Scorecard Gate
      - "*"
    types:
      - completed
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: xrepo-ultra-${{ github.ref }}
  cancel-in-progress: false

env:
  REPORT_DIR: .bithub/reports
  PV_FILE: ".bit/databank/personality_vectors.json"
  POLICY_PATH: ".bithubpolicy"
  SCHEMA_PATH: ".bitschemas"
  POWERTHRESHOLD: paranoid

jobs:
  sync_and_correct:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Safe
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Strict Intelligence Enforcement/Personality Vector Gate
        run: |
          set -euo pipefail
          echo "# STRICT Intelligence Enforcement (Failsafe Active)" >> "$GITHUB_STEP_SUMMARY"
          if [ -f "$PV_FILE" ]; then
            compscore=$(jq -r '.compscore // 0' "$PV_FILE")
            profanity=$(jq -r '.profanity // 0' "$PV_FILE")
            echo "- comp score: $compscore" >> "$GITHUB_STEP_SUMMARY"
            echo "- profanity: $profanity" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::No personality vector file found; skipping gate."
          fi

      - name: Audit Active Workflows (Failsafe)
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"
          gh run list --json database,headBranch,status --limit 50 > "${REPORT_DIR}/loop-state.json"

      - name: Sync Policies & Schemas (Strict Boundary/Containment)
        env:
          BITHUBREPOURL: ${{ secrets.BITHUBREPOURL }}
        run: |
          set -euo pipefail
          mkdir -p "${POLICY_PATH}" "${SCHEMA_PATH}"
          if [ -n "${BITHUBREPOURL:-}" ] && git ls-remote "$BITHUBREPOURL" &> /dev/null; then
            git clone --depth=1 "$BITHUBREPOURL" tmpbithub
            rsync -av --ignore-existing tmpbithub/.bithubpolicy/ "${POLICY_PATH}/"
            rsync -av --ignore-existing tmpbithub/.bitschemas/ "${SCHEMA_PATH}/"
            rm -rf tmpbithub
          else
            echo "::warning::Bit.Hub repo unreachable, using local policy/schema only."
          fi

      - name: Upload Synced Policy/Schema Artifacts (Audit-Only, Non-Export)
        uses: actions/upload-artifact@v4
        with:
          name: bithub-policies-and-schemas
          path: |
            .bithubpolicy/**
            .bitschemas/**
          if-no-files-found: warn
          retention-days: 30
          compression-level: 6
          overwrite: true
          include-hidden-files: true

      - name: Enforce MetaCorrector (Audit-Only, Failsafe)
        uses: ./github/workflows/bit-hub-meta-corrector-v3.yml
        with:
          autofix: true
          powerthreshold: ${{ env.POWERTHRESHOLD }}
          targetref: main

  redeploy_if_clean:
    needs: sync_and_correct
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check MetaCorrector Report & Trigger Secure Deploy
        run: |
          set -euo pipefail
          REPORT=.bithubreports/meta-corrector-v3.ndjson
          BLOCK=0
          if [ -f "$REPORT" ]; then
            DENY=$(jq '.deny | length' "$REPORT")
            WARN=$(jq '.warn | length' "$REPORT")
            if [[ "$DENY" == "0" && ("$POWERTHRESHOLD" == "standard" || "$WARN" == "0") ]]; then
              echo "Ready for production deploy"
              gh workflow run "Bit.Hub Secure CD Supremacy Progressive Delivery" \
                -f environment=production \
                -f powerthreshold="$POWERTHRESHOLD"
            else
              echo "Blocking/warning issues; deploy halted for containment"
              BLOCK=1
            fi
          else
            echo "No report found; deploy blocked"
            BLOCK=1
          fi
          exit $BLOCK

  audit_and_cache:
    needs: redeploy_if_clean
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: BitBot Learning Enforcement (audit/failsafe)
        uses: ./github/workflows/bitbotcompliancelearning.yml
        with:
          retention: 5
